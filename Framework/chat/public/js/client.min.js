$(document).ready(function(){var a=io.connect(),b={chatname:"chatname",setPrivate:!1,pmTo:"pmTo",loggedIn:!1},c=0,d=0,e={},f=45,g=9,h=4;$("#clock").simpleClock(),$("#chat-box-send").hide(),$("#logout").hide(),$("#layer-pm-to").hide(),getTimeString=function(a){var b=new Date(a),c="";return c+=b.getHours()<10?"0"+b.getHours():b.getHours(),c+=":",c+=b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes()},writeServerMessage=function(a){var b=getTimeString(a.zeit),c=$("#update-template").html(),e=Handlebars.compile(c),f={time:b,servermessage:a.name+": "+a.text},h=e(f);$("#update-area").append(h),d++,d>g&&$("#update-area").children("div:first").remove()},writeChatMsg=function(a){var b=getTimeString(a.zeit),d=$("#chat-box-template").html(),e=Handlebars.compile(d),g="",h="";"privateTo"==a.type?g="text-orange":"privateSelf"==a.type&&(h="to: "+a.goesTo+": ");var i={time:b,fromUser:a.name,messagePre:h,message:a.text,fromUserClass:g},j=e(i);$("#talk-box-output").append(j).hide().fadeIn("slow"),c++,c>f&&$("#talk-box-output").children("div:first").remove();var k=$("#main"),l=$(window).height()-120-$("#talk-box-output").innerHeight();0>=l&&$("html, body").animate({scrollTop:k.height()},1100)},writeUserList=function(a){$("#onlineusers").html(""),$("#usercount").html(a.usercount),console.log(" userlist to write: "+JSON.stringify(a)),$.each(a.users,function(a,c){var d="user_"+a,e="span_"+a,f='privateMsg("'+d+'","'+e+'","'+c+'")',g={},h={};g["class"]="circle-header14",g.id=d,h["class"]="online-user",h.id=e,b.chatName!==c?(g["class"]+=" circle-header-norm cursor-pointer ",g.onClick=f,g.title="click for private message",h["class"]+=" cursor-pointer",h.onClick=f,h.title="click for private message"):(g["class"]+=" circle-header-current",h["class"]+=" online-user-current"),$("#onlineusers").append($("<div>").append($("<div>").attr(g),$("<span>").attr(h).text(c)))})},togglePmOff=function(a,c){e.user===a?(b.setPrivate=!1,b.pmTo="",console.log("togglePmOff [by"+c+"]: switch to norm chat, was to "+a),$("#"+e.div).removeClass("circle-header-pm"),$("#"+e.div).addClass("circle-header-norm"),$("#"+e.div).attr({title:"click for private message"}),$("#"+e.span).html(a),$("#"+e.span).removeClass("online-user-pm"),$("#"+e.span).attr({title:"click for private message"}),$("#layer-pm-to").text(""),$("#layer-pm-to").hide(),$("#text").val(""),$("#text").focus(),e={}):console.log("Warn: togglePmOff: no PM status for user: "+a)},togglePmOn=function(a,c,d,f){b.setPrivate=!0,b.pmTo=d,$("#"+a).removeClass("circle-header-norm"),$("#"+a).addClass("circle-header-pm"),$("#"+a).attr({title:"click again to discard private message"}),$("#"+c).html("=> "+d),$("#"+c).addClass("online-user-pm"),$("#"+c).attr({title:"click again to discard private message"}),$("#layer-pm-to").text("to: "+d),$("#layer-pm-to").show(),$("#text").focus(),e={div:a,span:c,user:d},console.log("togglePmOn: pm to "+d+" calledby: "+f)},privateMsg=function(a,c,d){b.setPrivate===!0&&d===e.user?togglePmOff(d,"privateMsg"):b.setPrivate===!1?(e={div:a,span:c,user:d},togglePmOn(a,c,d,"privateMsg")):console.log("privateMsg: user clicks falsly")},a.on("userList",function(a){b.loggedIn===!0&&writeUserList(a)}),a.on("statusMessage",function(a){console.log(" receiving statusmsg: "+JSON.stringify(a)),!0===a.loggedIn?(b.loggedIn=!0,console.log("successfully logged in .."),$("#chat-box-login").hide(),$("#chat-box-send").show(),$("#logout").show()):($("#name").val(""),console.log("chat entry, or login failed, name is chosen..")),$("#top-header-chat-left").text(a.status),$("#statusBar").text(a.text)}),a.on("serverMessage",function(a){b.loggedIn!==!0&&a.logoutMessage!==!0||(writeServerMessage(a),a.logoutMessage&&a.logoutUser==b.pmTo&&!0===b.setPrivate&&(togglePmOff(a.logoutUser,"socket"),console.log("Server calls togglePmOff for user: "+a.logoutUser)))}),a.on("chatMessage",function(a){b.loggedIn!==!0&&a.logoutMessage!==!0||writeChatMsg(a)}),chatten=function(){var c=$("#text").val().trim(),d=null;console.log("try to send:"+c),b.loggedIn===!0?c.length>=h?(b.setPrivate===!0&&(d=b.pmTo),a.emit("userMessage",{name:b.chatName,text:c,privateTo:d}),$("#text").val("")):console.log("chatten(): text too short!.."):$("#text").val("bitte einloggen")},login=function(){b.loggedIn===!1&&(b.chatName=$("#name").val().trim(),a.emit("login",{name:b.chatName}))},logout=function(){b.loggedIn===!0&&(a.emit("logout",{name:b.chatName}),b.loggedIn=!1,b.chatName="",console.log("currently logged out .."),$("#chat-box-send").hide(),$("#chat-box-login").show(),$("#logout").hide(),$("#onlineusers").html(""),$("#usercount").html(0))},$("#login").click(login),$("#logout").click(logout),$("#senden").click(chatten),$("#text").keypress(function(a){13==a.which&&chatten()}),$("#name").keypress(function(a){13==a.which&&login()})});